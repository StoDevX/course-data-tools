name: Update Course Data

on:
  schedule:
    - cron: "0 2 * * *"

permissions:
  contents: write
  pull-requests: write

jobs:
  update-data:
    # Adapted from https://github.com/StoDevX/AAO-React-Native/blob/master/.github/workflows/cocoapods.yml
    name: Course Data Update
    runs-on: ubuntu-latest
    timeout-minutes: 60

    strategy:
      matrix:
        python-version:
          - "3.11"

    env:
      GITHUB_BRANCH: ${{ github.ref_name }}

    steps:
      - name: "check out course-data-tools repo"
        uses: actions/checkout@v3

      - name: "check out course-data repo"
        uses: actions/checkout@v3
        with:
          repository: StoDevX/course-data
          path: ./course-data
          token: ${{ secrets.COURSE_DATA_TOOLS_GH_PUSH_TOKEN }}

      - name: "set up committer information for course-data repo"
        working-directory: ./course-data
        run: |
          git config user.name "Github Databot"
          git config user.email "hawkrives+sto-course-databot@gmail.com"

      - name: "Install poetry"
        run: pipx install poetry

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}
          cache: "poetry"

      - name: Install dependencies
        run: poetry install

      - name: Download course data files
        working-directory: ./course-data
        run: |
          for y in $(seq 1994 "$(date +%Y)"); do
            for s in $(seq 1 5); do
              echo "$y$s"
            done
          done | xargs -t -n1 -P1 -- course-data-tools download --force-terms -w 1

      - name: Perform datafile maintenance
        working-directory: ./course-data
        run: course-data-tools maintain-datafiles

      - name: Commit updated information to the main branch
        working-directory: ./course-data
        run: |
          if [[ $GITHUB_BRANCH != "master" ]]; then
            git checkout --quiet -b "$GITHUB_BRANCH"
          fi

          git add .
          git commit --quiet -m "course data update $(date)" || (echo "No updates found." && exit 0)

          if [[ $GITHUB_BRANCH == "master" ]]; then
            git push origin master
          else
            git push --force origin "$GITHUB_BRANCH"
          fi

      - name: push-on-course-data-change
        working-directory: ./course-data
        run: bash bin/github.sh
